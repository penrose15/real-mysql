# 4.1 Mysql 엔진 아키텍처

Mysql 서버는 사람의 머리를 담당하는 **Mysql 엔진**과 손발 역할을 하는 **스토리지 엔진**으로 구분할 수 있다.

**Mysql 엔진**

클라이언트로부터의 접속, 쿼리 요청을 처리하는 커넥션 핸들러와 SQL 파서, 전처리기, 옵티마이저가 중심을 이룬다.

**스토리지 엔진**

SQL문을 분석, 최적화하고, 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어온다.

Mysql 엔진은 하나이나 스토리지 엔진은 여러개를 동시에 사용할 수 있다.

**핸들러 API**

Mysql 엔진이 쿼리 실행기에서 **데이터를 쓰거나 읽어야 할 때 각 스토리지 엔진이 쓰기/읽기를 요청**하는데 이러한 요청을 **핸들러 요청**이라 하고 여기서 사용되는 API를 **핸들러 API** 라고 한다.

**Mysql 스레딩 구조**

Mysql 서버는 프로세스 기반이 아닌 **스레드 기반**으로 움직이며, 크게 **포그라운드 스레드**와 **백그라운드 스레드**로 구분된다.

**포그라운드 스레드(클라이언트 스레드)**

Mysql 서버에 접속한 클라이언트 수만큼 존재하며, 주로 각 **클라이언트 사용자가 요청하는 쿼리 문장**을 처리한다. 

클라이언트 사용자가 작업을 마치고 **커넥션을 종료하면 해당 커넥션을 담당하던 스레드는 다시 스레드 캐시로 돌아간다.** 

만약 이미 스레드 캐시에 **일정 개수 이상의 대기 중인 스레드가 있으면 스레드 캐시에 넣지 않고 스레드를 종료 시킨**다. (스레드 캐시에 유지시킬 수 있는 최대 스레드 개수 - thread_cache_size)

포그라운드 스레드는 데이터를 Mysql의 데이터 버퍼나 캐시로부터 가져오며, 버퍼나 캐시에 없는 경우에는 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와 작업을 처리한다.

**백그라운드 스레드**

로그 스레드, 버퍼와 데이터를 디스크로 내려 쓰는 작업을 하는 쓰기 스레드 등의 역할을 한다.

**메모리 할당 및 사용 구조**

**글로벌 메모리 영역**과 **로컬 메모리 영역**으로 구분된다.

글로벌 메모리 영역은 Mysql 서버가 시작되면서 운영체제로부터 할당된다.

**글로벌 메모리 영역**

클라이언트 스레드의 수와 무관하게 **하나의 메모리 공간만 할당**된다. 필요에 따라 2개이상의 메모리 공간을 할당받을 수 있으나 생성된 글로벌 영역이 N개일지라도 모든 스레드에 의해 공유된다.

- 테이블 캐시
- InnoDB버퍼 풀
- InnoDB 어댑티브 해시 인덱스
- InnoDB 리두 로그 버퍼

**로컬 메모리 영역(세션 메모리 영역)**

Mysql 서버상의 존재하는 **클라이언트 스레드가 쿼리를 처리하는데 사용되는 메모리 영역**이다.

클라이언트가 Mysql서버에 접속하면 Mysql 서버에서 클라이언트 커넥션으로부터 요청을 처리하기 위해 스레드를 하나씩 할당받게 되는데 이때 클라이언트 스레드가 사용하는 메모리 공간이다.

로컬 메모리는 각 클라이언트 스레드별로 독립적으로 할당되며, 절대 공유되어 사용되지 않는다.

- 정렬 버퍼
- 조인 버퍼
- 바이너리 로그 캐시
- 네트워크 버퍼

**플러그인 스토리지 엔진 모델**

Mysql은 기본적으로 많은 스토리지 엔진을 가지고 있으나 기본적으로 제공되는 스토리지 엔진 이외의 부가적인 기능을 지닌 스토리지 엔진을 개발 하는 것도 가능하다.

Mysql 쿼리가 실행되는 과정을 보면 대부분의 작업이 Mysql 엔진에서 처리되고 마지막 데이터 읽기/쓰기만 스토리지 엔진에 의해 처리된다. (만약 사용자가 새로운 스토리지 엔진을 만들어도 DBMS의 일부 기능만 수행한다는 뜻이다.)

**핸들러** : **Mysql 엔진이 스토리지 엔진을 조정하기 위해 사용하는 것**, Mysql 엔진이 각 스토리지 엔진에서 데이터를 읽어오거나 저장하도록 명령하려면 반드시 핸들러를 통해야 한다. 

**컴포넌트**

기존의 플러그인 아키텍처를 대체하기 위해 나타난 컴포넌트 아키텍처

**쿼리 실행 구조**

1. 쿼리 파서 : 사용자의 요청으로 들어온 쿼리 문장을 토큰으로 분리하여 트리 형태의 구조로 만들어 내는 작업을 의미한다.
2.  전처리기 : 파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인한다.
3. 옵티마이저 : 사용자의 요청으로 들어온 쿼리문장을 저렴한 비용으로 가장 빠르게 처리할지를 결정한다.
4. 실행 엔진 : 옵티마이저의 계획을 각 핸들러에게 요청하고 핸들러에게 받은 결과를 또 다른 핸들러의 요청의 입력으로 연결하는 역할을 한다.
5. 핸들러 : Mysql 서버의 가장 밑단에서 Mysql 실행 엔진의 요청에 따라 데이터를 디스크에 저장하고 디스크로부터 읽어오는 역할을 담당한다.
6. 쿼리 캐시 : SQL 실행 결과를 메모리에 캐시하고 동일 SQL이 실행되면 테이블을 읽지 않고 즉시 결과를 반환하기 때문에 빠른 성능을 보이나… 테이블 데이터가 변경되면 저장된 관련된 캐시를 전부 삭제해야 해서 성능 저하를 일으켰다. 결국 Mysql 8.0에서 완전히 삭제 되었다고 한다.
7. 스레드 풀(여기서는 Percona Server에서 제공되는 스레드 풀) : 스레드 풀은 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여 동시 처리되는 요청이 많다 하더라도 Mysql 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있도록 하여 서버의 자원 낭비를 줄이는 것이 목적이다.
기본적으로 CPU 코어의 개수만큼 스레드 그룹을 생성하고 실제로 CPU 코어 개수와 맞추는 것이 CPU 프로세서 친화도를 높이는데 좋다.
스레드 풀 타이머는 주기적으로 스레드 그룹의 상태를 체크하여 시스템 변수에 저장된 밀리 초만큼 작업 스레드가 지금 처리중인 작업을 끝내지 못하면 새로운 스레드를 생성하여 스레드 그룹에 추가한다.
8. 트랜잭션 지원 메타데이터