# InnoDB 스토리지 엔진 아키텍처
- Mysql 에서 사용할 수 있는 스토리지 엔진 중 레코드 기반의 잠금을 제공하고, 높은 동시성 처리가 가능한 스토리지 엔진이다.


### InnoDB 의 특징

- 프라이머리 키에 의한 클러스터링
    - InnoDB의 모든 테이블은 기본적으로 프라이머리 키를 기준으로 클러스터링 되어 저장된다.\
    ➡️ 프라이머리 키 값의 순서대로 디스크에 저장되고, 모든 세컨더리 인텍스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용된다.\
    ➡️ 프라이머리 키가 클러스터링 인덱스이기 때문에 프라이머리 키를 이용한 Range 스켄이 상당히 빠르다

- 외래 키 지원
- MVCC(Multi Version Concurrency Control)
- 잠금 없는 일관된 읽기
    - MVCC 기술을 이용하여 잠금을 걸지 않고 읽기 작업을 수행한다.(다른 트랜잭션이 가지고 있는 잠금을 기다리지 않고 읽기 작업이 가능)
    - 격리 수준이 Serializable이 아닌 수준인 경우 Insert와 연결되지 않은 순수한 Select 는 다른 트랜잭션의 변경 작업과 관계없이 항상 잠금을 대기하지 않고 바로 실행된다.(언두 로그에 변경 전 데이터를 저장하고 언두로그에 저장된 데이터를 읽어옴)
- 자동 데드락 감지
    - 잠금이 교착 상태에 빠지지 않았는지 체크하기 위해 잠금 대기 목록을 그래프 형태로 관리한다.
    - 데드락 감지 스레드로 주기적으로 잠금 대기 그래프를 검사하여 교착 상태에 빠진 트랜잭션을 찾아 그 중 하나를 강제 종료 시킨다.
        - 언두 로그량이 적은 트랜잭션을 우선적으로 롤백시킨다.
- 자동화된 장애 복구
    - Mysql 서버가 시작될 때 완료되지 못한 트랜잭션이나 디스크에 일부만 기록된 데이터 페이지 등에 대한 일련의 복구 작업이 자동으로 진행된다.
- InnoDB 버퍼 풀
    - 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해 두는 공간이다. 
    - 쓰기 작업을 지연시켜 일괄 작업으로 처리할 수 있게 해주는 버퍼 역할도 같이 한다.
    - 버퍼 풀의 크기 설정
        - InnoDB 버퍼 풀의 크기를 적절히 작은 값으로 설정해서 조금씩 상황을 봐 가면서 증가 시켜야 한다.
    - 버퍼 풀의 구조
        - InnoDB 스토리지 엔진은 버퍼 풀이라는 거대한 메모리 공간을 페이지 크기의 조각으로 쪼개어 InnoDB 스토리지 엔진이 데이터를 필요로 할 때 해당 데이터 페이지를 읽어 각 조각에 저장한다.
        - LRU 리스트, 플러시 리스트, 프리 리스트라는 3개의 자료구조로 구성된다.
- Double Write Buffer
    - 리두 로그는 리두 로그 공간의 낭비를 막기 위해 페이지의 변경된 내용만 기록한다. 
    - 이로 인해 InnoDB의 스토리지 엔진에서 더티 페이지를 디스크 파일로 플러시할 때 일부만 기록되는 문제가 발생할 수 있다.(Partial-Page)
    - 이를 막기 위해 Double Write 기법을 활용한다. 
    - 데이터의 무결성이 매우 중요한 경우 Double Write 활성화를 고려하는 것이 좋다.
- 언두 로그
    - InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기 위해 DML 로 변경되기 이전 버전의 데이터를 별도로 백업한다. 이렇게 백업된 데이터를 언두 로그라고 한다.
    - DML 이 실행되면 실제 데이터 내용이 변경한 내용으로 변경되고, 변경되기 이전의 값은 언두 로그에 저장된다. 만약 이상태로 커밋 되면 현재 상태가 그대로 유지되고 만약 롤백되면 언두 로그에 백업된 데이터로 다시 복구된다.
        - 언두 로그가 저장되는 공간을 언두 테이블이라고 한다.(Undo Tablespace) 
        - 언두 로그는 항상 시스템 테이블스페이스 외부의 별고 로그 파일에 기록된다.
- 체인지 버퍼
    - 데이터를 INSERT, UPDATE 시 테이블에 포함된 인덱스를 업데이트 해야 한다.
    - 만약 인덱스 페이지가 디스크에 존재한다면, 즉시 실행하지 않고 임시 공간에 저장해두고 바로 사용자에게 결과를 반환하는 형태로 성능을 향상시키는데 이때 사용하는 임시 메모리 공간을 체인지 버퍼라고 한다.
    - 사용자에게 결과 전달을 위해 중복 여부를 체크해야 하는 유니크 인덱스는 체인지 버퍼를 사용하지 않는다.
    - 체인지 버퍼에 임시로 저장된 인덱스 레코드 조각은 이후 백그라운드 스레드에 의해 병합되는데 이 스레드를 머지 스레드라고 한다.
    - 
- 리두 로그 및 로그 버퍼
    - 하드웨어나 소프트웨어 등 여러 문제점으로 인해 비정상적으로 종료되었을 경우 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안전장치이다.
    - InnoDB 버퍼 풀이나 로그 버퍼는 리두 로그를 버퍼링 할 수 있다.
    - DB 서버에서 리두 로그는 트랜잭션이 커밋되면 즉시 디스크로 기록되도록 시스템 변수를 설정하는 것이 좋다.
- 어댑티브 해시 인덱스
    - 사용자가 수동으로 생성하는 인덱스가 아닌 InnoDB 스토리지 엔진에서 사용자가 자주 요청하는 데이터에 대해 자동으로 생성하는 인덱스이다.
    - B-Tree 검색 시간을 줄여주기 위해 도입된 기능이다. 자주 읽히는 데이터 페이지의 키 값을 이용해 해시 인덱스를 만들고, 필요할 때마다 어댑티브 해시 인덱스를 검색하여 레코드가 저장된 데이터 페이지를 즉시 찾아갈 수 있다.
    - 디스크 데이터가 InnoDB 버퍼 풀 크기와 비슷한 경우, 동등 조건 검색이 많은 경우, 쿼리가 데이터 중에서 일부 데이터에 집중되는 경우 사용하면 성능 향상에 도움이 된다.