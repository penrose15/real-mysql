# Mysql 엔진의 잠금

* Mysql에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 Mysql 엔진 레벨로 나눌 수 있다.

    * Mysql 엔진은 스토리지 엔진을 제외한 부분으로 Mysql 엔진 잠금은 모든 스토리지 엔진에 영향을 미치나 스토리지 엔진 잠금은 스토리지 엔진 간 상호작용에 영향을 미치지 않는다.
* Mysql 엔진에는 

    * 테이블 데이터 동기화를 위한 **테이블 락**
    * 테이블의 구조를 잠그는 **메타데이터 락**
    * 사용자의 필요에 맞게 사용할 수 있는 **네임드 락**

    이 존재한다

### 5.2.1 글로벌 락

* `FLUSH TABLE WITH READ LOCK`명령으로 획득할 수 있으며 Mysql이 제공하는 잠금 가운데 가장 범위가 크다
* 한 세션에서 글로벌 락을 획득하면 다른 세션에서 SELECT를 제외한 대부분의 DDL문장이나 DML문장을 실행하는 경우 글로벌 락이 해제될 때까지 대기상태로 남는다.
* 범위는 Mysql 서버 전체이다.
* Mysql 8.0이후에는 좀 더 가벼운 백업 락이 도입되었다. 

#### 백업 락
백업 락이 실행되면 모든 세션에 아래와 같은 동작이 제한된다.
* 데이터베이스 및 테이블 등 모든 객체 생성 및 변경, 삭제
* REPAIR TABLE과 OBTIMIZE TABLE 명령
* 사용자 관리 및 비번 변경

하지만 일반적인 테이블의 데이터 변경은 가능하다

-> 백업락은 레플리카 서버(Replica Server)에서 실행되기 때문

### 5.2.2 테이블 락
* 개별 테이블 단위로 설정되는 잠금
* InnoDB테이블인 경우 스토리지 엔진 차원에서 레코드 기반의 잠금이 제공되므로 단순 데이터 변경 쿼리로 인해 묵시적인 테이블 락이 설정되지는 않는다. (DDL 의 경우에만 영향을 미침)

### 5.2.3 네임드 락
* `GET_LOCK()`를 통해 임의의 문자열에 대해 잠금을 설정할 수 있다.
* 네임드 락은 단순히 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금이다.
* 여러 클라이언트가 상호 동기화를 처리해야 할 때, 많은 레코드에 대해 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하게 사용된다. 

    * 배치 프로그램 같이 한꺼번에 많은 레코드를 변경하는 경우 동일한 데이터를 변경하거나 참조하는 프로그램끼리 분류하여 네임드 락을 걸면 데드락 문제를 피할 수 있다.

### 5.2.4 메타데이터 락
* 데이터베이스 객체의 이름이나 구조를 변경하는 경우에 획득하는 잠금
* 명시적으로 획득할 수는 없고 테이블 이름을 변경하는 경우 자동으로 획득이 가능하다.

